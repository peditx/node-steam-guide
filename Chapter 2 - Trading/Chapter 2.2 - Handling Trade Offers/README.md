# فصل 2.2 - مدیریت پیشنهادات تجارت

برای شروع این فصل، بیایید کد نوشته شده در فصل قبلی را به یک فایل جدید کپی کنیم. نام آن را `project2.js` بگذارید. کدی که در [فصل 1](../../Chapter%201%20-%20Basics) نوشتیم، از این به بعد کدی خواهد بود که برای ساخت تمامی ربات‌های خود از آن استفاده می‌کنیم. این کد شالوده ربات‌هایی است که در آینده می‌سازیم.

بیایید شروع به اضافه کردن کد به ابتدای پروژه‌مان کنیم که از `project1.js` کپی کرده‌ایم.

```js
const SteamUser = require('steam-user');
const SteamTotp = require('steam-totp');
const SteamCommunity = require('steamcommunity');
const TradeOfferManager = require('steam-tradeoffer-manager');

const client = new SteamUser();
const community = new SteamCommunity();
const manager = new TradeOfferManager({
	steam: client,
	community: community,
	language: 'en'
});

[...]
```

خوب است. ما دو ماژول جدید را `require` کردیم و نمونه‌هایی جدید از هر دو آن‌ها ساختیم. علاوه بر این، چند پارامتر اضافی به سازنده ماژول `TradeOfferManager` ارسال کردیم. به آن گفتیم که از متغیر `client` برای دسترسی به Steam استفاده کند و از `community` برای دسترسی به Steam Community. اگر این گزینه‌ها را مشخص نمی‌کردیم، نمونه جدیدی از این ماژول‌ها در داخل نمونه `TradeOfferManager` ساخته می‌شد، اما ما نمونه‌های خودمان را می‌دهیم تا در آینده قابلیت تنظیمات بیشتری داشته باشیم. همچنین به `TradeOfferManager` گفتیم که از زبان انگلیسی استفاده کند تا نام‌های انگلیسی اقلام در پیشنهادات تجارت را دریافت کنیم.

بیایید کد بیشتری اضافه کنیم.

```js
client.on('webSession', (sessionid, cookies) => {
  manager.setCookies(cookies);

  community.setCookies(cookies);
  community.startConfirmationChecker(10000, 'your_identity_secret');
});
```

در اینجا، یک شنونده رویداد جدید به نمونه `client` اضافه کردیم. ما منتظر رویداد `webSession` هستیم، که زمانی که شناسه نشست و کوکی‌ها از سرورهای Steam دریافت می‌شود، ایجاد می‌شود. سپس این کوکی‌ها را به `manager` و `community` ارسال می‌کنیم که به این ترتیب می‌توانند وارد Steam شوند. همچنین به نمونه `community` گفتیم که هر 10 ثانیه بررسی کند که آیا تأییدیه معلقی داریم یا خیر و اگر داشتیم، آن را قبول کند. این نیازمند وارد کردن شناسه هویت شما است، که در [فصل 1.4](../../Chapter%201%20-%20Basics/Chapter%201.4%20-%20TOTP/#how-to-find-your-secrets) توضیح داده شده است.

خوب، حالا `manager`، `client` و `community` همگی وارد Steam شده‌اند. حالا بیایید با این همه کد کاری کنیم. ابتدا شروع می‌کنیم به قبول کردن تمامی پیشنهادات تجارت ورودی که از حساب‌هایی که به آن‌ها اعتماد داریم، ارسال شده‌اند.

```js
manager.on('newOffer', offer => {
  if (offer.partner.getSteamID64() === 'your_trusted_account_id') {
    offer.accept((err, status) => {
      if (err) {
        console.log(err);
      } else {
        console.log(`Accepted offer. Status: ${status}.`);
      }
    });
  }
});
```

خب، این یک مقدار کد زیاد است، اما بیایید گام به گام آن را بررسی کنیم.

ابتدا یک شنونده رویداد به `manager` اضافه کردیم. این شنونده رویداد منتظر رویداد `newOffer` است، که زمانی که پیشنهاد جدیدی دریافت می‌کنیم، ایجاد می‌شود. سپس بررسی می‌کنیم که آیا Steam ID 64 بیتی ارسال‌کننده همان چیزی است که ما به آن اعتماد داریم یا نه. به عنوان مثال، من `your_trusted_account_id` را با `76561198092490523` جایگزین می‌کنم. این عدد طولانی که می‌بینید، Steam ID 64 بیتی حساب Steam من است. پیدا کردن این عدد آسان است – در لینک پروفایل Steam شما موجود است. پروفایل من را می‌توانید در [steamcommunity.com/profiles/76561198092490523](https://steamcommunity.com/profiles/76561198092490523) مشاهده کنید.

اگر این دو Steam ID برابر باشند، پیشنهاد را با استفاده از متد `.accept()` پذیرفته و کال‌بک را فراخوانی می‌کنیم. زمانی که پیشنهاد پذیرفته شد (یا با خطا مواجه شد)، کال‌بک فراخوانی می‌شود. اگر همه چیز به درستی پیش برود، باید پیام "Accepted offer. Status: pending/accepted/escrow." را مشاهده کنید.

برای آزمایش این، برنامه را با استفاده از `node project2.js` اجرا کنید و از حساب مورد اعتماد پیشنهاد ارسال کنید. اگر حساب دومی ندارید، می‌توانید از Steam ID یک دوست برای حساب مورد اعتماد استفاده کنید و از او بخواهید که پیشنهاد را برای ربات شما ارسال کند.

> **توجه داشته باشید که ربات شما باید حداقل یک خرید $5 روی Steam داشته باشد تا واجد شرایط دریافت پیشنهادات تجارت باشد. در غیر این صورت، رویداد `newOffer` فعال نخواهد شد.**

قطعا وقتی پیشنهاد ارسال می‌شود، چیزی شبیه به این باید در کنسول شما نمایش داده شود:

![console.png](./screenshots/console.png)

سپس، پس از دادن زمان کافی به برنامه (باید کمتر از ~30 ثانیه باشد) تا پیشنهاد را با Steam تأیید کند، باید ببینید که پیشنهاد در Steam پذیرفته شده است:

![trade.png](./screenshots/trade.png)

عالی! اگر همه چیز برای شما به درستی کار کرد، می‌توانیم ادامه دهیم.

اگر یک کلاهبردار پیشنهاداتی برای ربات شما ارسال کند و بخواهد Karambit Fade جدید شما یا کلاه خاصی که به دنبال خریدش بودید را بگیرد چه؟ خوشبختانه، ما آن بررسی را اضافه کردیم تا فقط پیشنهادات ارسال‌شده از حساب مورد اعتماد را قبول کنیم، اما احتمالاً نمی‌خواهیم که پیشنهادات کلاهبرداران در بین پیشنهادات ما بماند و صندوق ورودی پیشنهادات را شلوغ کند. می‌توانیم به راحتی این پیشنهادات را رد کنیم با اضافه کردن کمی کد بیشتر به کدی که قبلاً نوشتیم.

```js
manager.on('newOffer', offer => {
  if (offer.partner.getSteamID64() === 'your_trusted_account_id') {
    offer.accept((err, status) => {
      if (err) {
        console.log(err);
      } else {
        console.log(`Accepted offer. Status: ${status}.`);
      }
    });
  } else {
    offer.decline(err => {
      if (err) {
        console.log(err);
      } else {
        console.log('Canceled offer from scammer.');
      }
    });
  }
});
```

همانطور که مشاهده می‌کنید، تنها کاری که انجام دادیم این است که یک دستور `else` به بررسی Steam ID خود اضافه کردیم، که از متد `.decline()` برای رد پیشنهاد استفاده می‌کند. اگر خطایی وجود داشته باشد، آن را در خط فرمان ثبت می‌کنیم. در غیر این صورت، پیام "Canceled offer from scammer." را چاپ می‌کنیم.

عالی! شما اکنون اولین برنامه ساده خود برای مدیریت پیشنهادات تجارت را دارید. در فصل بعد، روی ارسال پیشنهادات به کاربران کار خواهیم کرد.

[ادامه خواندن](../Chapter%202.3%20-%20Sending%20Trade%20Offers)
